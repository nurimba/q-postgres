'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _sqlWhere=require('./sqlWhere'),_sqlWhere2=_interopRequireDefault(_sqlWhere),_sqlUtils=require('./sqlUtils');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var toSQL=function toSQL(_ref){for(var a=_ref.table,b=_ref.selectFields,c=_ref.conditional,d=_ref.limitRows,e=_ref.orderFields,f=_ref.joinTables,g=_ref.groupFields,h='\nSELECT '+b+'\nFROM '+a+'\n'+f+'\n'+c+'\n'+g+'\n'+e+'\n'+d+'\n';-1!==h.indexOf(_sqlUtils.blankLine);)h=h.replace(_sqlUtils.blankLine,_sqlUtils.breakLine);return h.trim()},pagination=function pagination(_ref2){var a=_ref2.limit,b=_ref2.page;if(!a)return'';if(!b)return'LIMIT '+a;var c=(b-1)*a;return c?'LIMIT '+a+' OFFSET '+c:'LIMIT '+a},orderByFields=function orderByFields(_ref3){var a=_ref3.table,b=_ref3.select,c=_ref3.orderBy,d=_ref3.count;if(!c)return'';var e=c.map(function(f){var g=f.field,h=f.order,i=f.table||a,j=b.find(function(l){var m=l.field,n=l.table||a;return m===g&&n===i});if(!j)return(i+'.'+g+' '+(h||'')).trim();var k=b.indexOf(j)+1;return d&&k++,(k+' '+(h||'')).trim()}).join(', ');return e?'ORDER BY '+e:''},joinReferences=function joinReferences(_ref4){var a=_ref4.joins;return a?a.map(function(b){if('string'==typeof b)return b;var c=b.tableRef,d=b.fieldRef,e=b.tableLink,f=b.fieldLink;return'JOIN '+c+' ON ('+c+'.'+d+' = '+e+'.'+f+')'}).join(_sqlUtils.breakLine):''},filterSelect=function filterSelect(_ref5,_ref6){var b=_ref6.select,c=_ref6.func,a=_ref5.grouping;return a&&c?!1:b===void 0||!!b},mountFieldName=function mountFieldName(a,b,c){var d=b[0].toUpperCase().concat(b.substring(1,b.length));return c?c+'('+a+'.'+b+') AS '+c.toLowerCase()+d:a+'.'+b},mountFieldNameAlias=function mountFieldNameAlias(a,b,c){var d=b[0].toUpperCase().concat(b.substring(1,b.length));if(c){var e=a[0].toUpperCase().concat(a.substring(1,a.length));return c+'('+a+'.'+b+') AS '+c.toLowerCase()+e+d}return a+'.'+b+' AS '+a+d},prepareSelect=function prepareSelect(a){var b=a.select;return b.filter(filterSelect.bind(void 0,a)).map(function(c){var d=a.table,e=a.grouping,f=c.field,g=c.func,h=c.table||d;return e?h+'.'+f:h===d?mountFieldName(h,f,g):mountFieldNameAlias(h,f,g)})},selFields=function selFields(_ref7){var a=_ref7.table,b=_ref7.select,c=_ref7.count,d=_ref7.distinct;d&&c&&(d=!1);var e=prepareSelect({select:b,table:a}).join(', ');return c?'COUNT(-1) AS _counter'+(e?', '.concat(e):''):d?'DISTINCT '+e:e},groupBy=function groupBy(_ref8){var a=_ref8.select,b=_ref8.table,c=_ref8.count;if(!a)return'';var d=prepareSelect({select:a,table:b,grouping:!0}).join(', '),e=!!a.find(function(_ref9){var f=_ref9.func;return!!f});return(c||e)&&d?'GROUP BY '+d:''};exports.default=function(_ref10){var a=_ref10.table,b=_ref10.select,c=_ref10.where,d=_ref10.distinct,e=_ref10.limit,f=_ref10.page,g=_ref10.orderBy,h=_ref10.joins,i=_ref10.count,j=selFields({table:a,select:b,count:i,distinct:d}),k=orderByFields({table:a,select:b,orderBy:g,count:i}),l=joinReferences({joins:h}),m=(0,_sqlWhere2.default)({select:b,where:c,table:a}),n=pagination({limit:e,page:f}),o=groupBy({select:b,table:a,count:i});return toSQL({table:a,selectFields:j,conditional:m,limitRows:n,orderFields:k,joinTables:l,groupFields:o})};